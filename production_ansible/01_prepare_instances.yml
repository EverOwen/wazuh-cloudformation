---
    - hosts: localhost
      vars:
        user_region: "<region>"
        user_KeyPair: "<KeyPairName>"
        user_AvZone: "<AvailabilityZone>"
        user_stack_name: wazuh-prod-env
      tasks:
        - name: Create a cloudformation stack
          cloudformation:
            stack_name: "{{ user_stack_name }}"
            state: "present"
            region: "{{ user_region }}"
            template: "templates/wazuh_template.yml"
            template_parameters:
              KeyPairName: "{{ user_KeyPair }}"
              AvailabilityZone: "{{ user_AvZone }}"

        - cloudformation_info:
            stack_name: "{{ user_stack_name }}"
            region: "{{ user_region }}"
          register: stack_info

        - set_fact:
            addresses: "{{ stack_info | json_query('cloudformation.*.stack_outputs') | list }}"

        - set_fact:
              elastic_nodes:
                  - PublicIP: "{{ addresses.0.ElasticBootstrapIp }}"
                    PrivateIP: "{{ addresses.0.ElasticBootstrapIpPrivate }}"
                  - PublicIP: "{{ addresses.0.ElasticMasterBIp }}"
                    PrivateIP: "{{ addresses.0.ElasticMasterBIpPrivate }}"
                  - PublicIP: "{{ addresses.0.ElasticMasterCIp }}"
                    PrivateIP: "{{ addresses.0.ElasticMasterCIpPrivate }}"
              kibana_nodes:
                  - PublicIP: "{{ addresses.0.KibanaInstanceIp }}"
                    PrivateIP: "{{ addresses.0.KibanaInstanceIpPrivate }}"
              wazuh_master_nodes:
                  - PublicIP: "{{ addresses.0.WazuhMasterInstanceIp }}"
                    PrivateIP: "{{ addresses.0.WazuhMasterInstanceIpPrivate }}"
              wazuh_worker_nodes:
                  - PublicIP: "{{ addresses.0.WazuhWorkerInstanceIp }}"
                    PrivateIP: "{{ addresses.0.WazuhWorkerInstanceIpPrivate }}"

    - hosts: localhost
      vars:
        elastic_user: admin
        elastic_password: admin_pass
        ssh_key_path_private: <ssh_key_path>
        elastic_version: 7.6.2
        wazuh_version: 3.12.3-1
        wazuh_api_admin_username: foo
        wazuh_api_admin_password: bar
        wazuh_api_password: bar
      tasks:
        - name: Rendering hosts file with the output IPs
          template:
            src: "templates/ansible_hosts.j2"
            dest: "wazuh_hostfile"
            mode: '664'
            force: yes

        - name: Clean destination folder for wazuh-ansible repository
          file:
            path: "/tmp/wazuh-ansible"
            state: absent

        - name: Create destination folder for wazuh-ansible repository
          file:
            path: "/tmp/wazuh-ansible"
            state: directory
            mode: '0777'

        - name: Cloning https://github.com/wazuh/wazuh-ansible
          git:
            repo: "https://github.com/wazuh/wazuh-ansible.git"
            dest: "/tmp/wazuh-ansible"
            version: "devel"

        - name: Ensure permissions on wazuh-ansible repo folder
          file:
            path: "/tmp/wazuh-ansible"
            state: directory
            mode: '0777'
            recurse: yes
